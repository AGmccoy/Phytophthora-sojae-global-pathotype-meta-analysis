---
title: "P. sojae meta analysis"
author: "Austin McCoy"
date: "`r format(Sys.time(), '%B %d %Y')`"
output: 
  html_document:
          keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Objectives
Single-gene resistance to _Phytophthora sojae_ is the most economic form of resistance, and can completely protect plants from infection all season if the gene used is effective against the pathogen population. Since the first report of _Phytophthora sojae_ in Indiana in 19XX (Kaufmann and Gerdmann 19XX) many pathotype surveys have been conducted to determine effective resistance genes for _P. sojae_ management. Nearly all surveys noted that the pathogen populations were very diverse and typically no single resistance gene could protect against all identified pathotypes. Likewise, upon subsequent sampling of the same soybean growing areas, an increase in average pathotype complexity (or how many genes, on average, an isolate from the sampled population could cause disease on) was observed in most locations. Currently, the most deployed resistance genes in North America are the Rps1c and Rps1k genes, and to some extent Rps1a, Rps3a, and Rps6. Most recent pathotype surveys in North America have noted a marked increase in virulence on the Rps1c and Rps1k genes primarily used for management. 

Therefore, the objectives of this study are:

* Identify how pathotypes have changed over time in North America, Argentina, and China
    * Significant changes in complexity, as well as effective resistance genes over time (i.e. loss of Rps1c and Rps1k for resistance in North America)
    
* Identify regional virulence trends to aid breeding efforts
    * Compare pathotype diversity between states/provinces and countries

------------

Packages needed for data exploration and analysis
```{r packages, echo=TRUE, message=FALSE, warning=FALSE}
library(openxlsx)
library(plyr)
library(tidyverse)
library(DT)
library(hagis)
library(pander)
library(vegan)
library(ape)
library(ggsignif)
library(cowplot)
library(ellipse)
```

Reading in the various studies data
```{r reading in data, echo=TRUE, warning=FALSE}
path_to_file <- "./pathotype surveys data.xlsx" # path to the file with all the pathotype data in it
sheet_names <- openxlsx::getSheetNames(path_to_file) # acquiring sheet names, i.e. each studies name for the data found in each sheet
pathotype_data <- lapply(sheet_names, openxlsx::read.xlsx, xlsxFile=path_to_file) #acquiring the pathotype data from each sheet
names(pathotype_data) <- sheet_names # adding the sheets names to each sheet
#pathotype_data # lets see what it looks like, ~80k entries, not a good idea
```

Removing the data.frames which do not have pathotype data, so we just have study data to work with (i.e. surveys summary, Rps gene introduction dates, soybean differentials info, number strings for isolate name). This "list" will need to be updated if any new non-data sheets are added. Simply add the sheet name to be removed to the list, and it will be removed.
```{r removing unneeded data.frames}
pathotype_data[c("surveys summary","Rps gene introduction dates", "soybean differentials info", "number strings for isolate name")]=NULL

```

Combining the list of data.frames into one data.frame and renaming the new column ".id" to "study"
```{r combining data.frames}
pathotype_data_combined <- ldply(pathotype_data, rbind) # combining each data.frame
names(pathotype_data_combined)[names(pathotype_data_combined)==".id"] <- "study" # renaming the new ".id" column to "study"
#pathotype_data_combined # lets take an updated look at the data structure, ~80k entries, still not a good idea
```

OK, now we have all of the pathotype studies data in one data.frame. This will be updated whenever a new study is added to the excel sheet and this .Rmd file re-run, with no additional effort. The only caveat is if another excel sheet is added which needs to be removed. This excel sheet name will need to be included in the list within the chunk for "removing data.frames which do not have pathotype data".


Lets take a look at the state/province, country, and years we have to work with in this interactive table
```{r study/data timepoint summary}

study_state_prov_country_year <- unique(pathotype_data_combined[c("study","state_prov", "country", "year")]) # looking at the unique values for state/province, country and year by study
datatable(study_state_prov_country_year, rownames = FALSE, class = 'cell-border stripe', filter="top", options = list(pageLength = 5, scrollX=T, editable=FALSE) )

```
This information will be helpful in making a timeline of pathotype studies conducted. We have `r length(study_state_prov_country_year$study)` timepoints from the `r length(unique(study_state_prov_country_year$study))` studies we are using

This is very informative, but a lot to look at. Lets break it down just by country and year to see if that makes it easier to look at/interpret. Again, using an interactive table.

```{r unique country and year interactions}
country_year <- unique(pathotype_data_combined[c("country", "year")]) # looking at the unique values for country and year 
datatable(country_year, rownames = FALSE, class = 'cell-border stripe', filter="top", options = list(pageLength = 5, scrollX=T, editable=FALSE) )
```
```{r}
database_all_countries <- unique(pathotype_data_combined$country)
  database_all_countries
databse_total_isolates <- length(unique(pathotype_data_combined$Isolate))
databse_total_isolates
database_total_studies <- unique(pathotype_data_combined$study)
database_total_studies

```

Now that we have an idea of the timeline of our sampling, lets calculate pathotype complexity by study so we can do analyses downstream looking at changes in pathotype complexity over time.
Remember, this is using all of the genes tested in each study. for downstream analysis/visualization we may sub-sample down to only the widely deployed genes (Rps1a, Rps1c, Rps1k, Rps3a, Rps6).

To summarise the pathotype complexity of each isolate and study, we will use the _hagis_ R package, for which we will need to set up the arguments used in _hagis_.
```{r}
hagis_args <- list(
  x = pathotype_data_combined,
  
  cutoff = 1, 
  
  control = "rps",
  
  sample = "Isolate",
  
  gene = "Rps",
  
  perc_susc = "Susceptible.1" 
  
)

#trying to get an average complexity output for each study

isolate_metadata <- pathotype_data_combined[c("Isolate","study" , "country", "year" )]

#complexity_by_study
complexity <- do.call(calculate_complexities, hagis_args) # this assigns complexity to each isolate but does not group by study
isolate_complexity <- complexity$indvidual_complexities # taking individual isolates data, not data summarized by complexity
names(isolate_complexity)[names(isolate_complexity)=="sample"] <- "Isolate" # renaming columns so we can merge data.frames
names(isolate_complexity)[names(isolate_complexity)=="N_samp"] <- "path_comp" # renaming columns so we can merge data.frames 
isolate_complexity_metadata <- merge(isolate_complexity, isolate_metadata, by.x = c("Isolate"), by.y = c("Isolate"), all=F) # merging metadata and the complexity data
isolate_complexity_metadata # merged data.frame

study_mean_complexity <- isolate_complexity_metadata %>%
  group_by(study, country) %>%
  mutate() %>%
  summarize(mean_comp=mean(path_comp),
            sd_comp=sd(path_comp),
            study_n=length(unique(Isolate)))
   # this will give us the mean and standard deviation for pathotype complexities, as well as number of isolates tested by study. 

pander(study_mean_complexity) # using pander for aesthetically appealing tables in R-markdown
```

Complexity is very helpful in understanding HOW MANY genes a isolate or sampled population can overcome, however, knowing WHICH genes are not effective to manage _Phytophthora sojae_ is still needed.


Virulence of sampled population on each tested Rps gene, by study, presented in an interactive table
```{r}
study_gene_summary <- pathotype_data_combined %>%
  group_by(study, Rps) %>%
  mutate() %>%
  summarize(N_pathogenic=sum(Susceptible.1),
            perc_pathogenic=((N_pathogenic)/(length(unique(Isolate)))*100))
# this will give us the number and percent of isolates pathogenic on each Rps gene tested, for each study we have.

datatable(study_gene_summary, rownames = FALSE, class = 'cell-border stripe', filter="top", options = list(pageLength = 5, scrollX=T, editable=FALSE) )

```

----------

# Data Preparation

Looking at the sampling dates for each study we can identify which studies will be appropriate to group together and investigate virulence changes over time for this meta-analysis. There are, of course, some studies which we will not be able to use. 

### Selection of time points was done based on the year samples were collected and not the year the study was published.

Based on the study data we have, it looks like we can investigate changes in virulence over the course of 3 timepoints For the U.S. and Argentina (1990-1999, 2000-2013, and 2014-2019 ), and 2 timepoints for Canada and China (2000-2013, 2014-2019).The 2014-2019 timepoint would represent the most recent data available for _Phytophthora sojae_ pathotype surveys.

We now have summary data for pathotype complexity and virulence on each gene tested, by study. Next, lets take the timepoints that we have defined above, and look at the data temporally in the United States and South America (Argentina)(1990-1999, 2000-2013, 2014-2019), as well as Canada and Asia (China)(2000-2013, 2014-2019). (i.e. what we are actually interested in looking at)

----------

## Selection of Rps genes to use for this study

To make sure we are making accurate comparisons, we need to subsample down to only the genes which were used in all analyses. We are going to only take the data for the 8 differentials used originally for race typing isolates (), and not the expanded 14 differential set since the additional 6 genes were not tested in past surveys. Those genes are: rps, Rps1a, Rps1b, Rps1c, Rps1d, Rps1k, Rps3a, Rps6, and Rps7. 

```{r}
rps_subset <- c("rps","1a","1b","1c","1d","1k","3a","6","7") # Rps genes we want to use for analyses

pathotype_data_combined_s9 <- pathotype_data_combined %>%
  subset(., Rps %in% rps_subset) # this will subset the combined dataset so that only the Rps genes we want to use in analyses will be present. All other isolate/gene phenotype data is discarded.

unique(pathotype_data_combined_s9$Rps) # double checking that only the isolates we want are in the subsetted dataset.

```

----------

## USA timepoints (1990-1999, 2000-2013, 2013-2019)

```{r, assigning studies to defined time points}
# USA 1990-1999 data
USA_1990_1999 <- pathotype_data_combined_s9 %>% # gathering all isolate data for the years 1990-1999 in the USA
  subset(country=="USA") %>%
  subset(year>=1990 & year<= 1999) %>%
  add_column(time_point="1990_1999", .after="study")



unique(USA_1990_1999$study) # double checking the correct studies were subset
unique(USA_1990_1999$year) # double checking our subsetting of years was correct
USA_1990_1999_isolates <- length(unique(USA_1990_1999$Isolate)) # number of isolates we have for this time point
USA_1990_1999_isolates 

# USA 2000-2013

USA_2000_2013 <- pathotype_data_combined_s9 %>% # gathering all isolate data for the years 2000-2013 in the USA
  subset(country=="USA") %>%
  subset(year>=2000 & year<= 2013) %>%
  add_column(time_point="2000_2013", .after="study")

unique(USA_2000_2013$study)
unique(USA_2000_2013$year)
USA_2000_2013_isolates <- length(unique(USA_2000_2013$Isolate))  
USA_2000_2013_isolates

# USA 2013-2019

USA_2013_2019 <- pathotype_data_combined_s9 %>% # gathering all isolate data for the years 2013-2019 in the USA
  subset(country=="USA") %>%
  subset(year>=2013 & year<= 2019) %>%
  add_column(time_point="2013_2019", .after="study") # A caveat, 2013 was used here so that Chowdhury 2021 (South Dakota) would be included in this group. Their sampling started in 2013 and continued through 2017. I believe it makes more sense to group Chowdhury with the other most recent studies in the U.S. for this temporal study, as they sampled many of the same years as other states.

unique(USA_2013_2019$study)
unique(USA_2013_2019$year)
USA_2013_2019_isolates <- length(unique(USA_2013_2019$Isolate))  
USA_2013_2019_isolates

USA_final_data <- rbind(USA_1990_1999,USA_2000_2013,USA_2013_2019)

```

---------

## Argentina timepoints (1990-1999, 2000-2013, 2014-2019)

```{r}
# Argentina 1989-1999 data
ARG_1989_1999 <- pathotype_data_combined_s9 %>% # gathering all isolate data for the years 1990-1999 in Argentina
  subset(country=="Argentina") %>%
  subset(year>=1989 & year<= 1999) %>%
  add_column(time_point="1989_1999", .after="study") # Barreto 1995 started sampling in 1989 and ended in 1992, thus it was included in this timepoint.

unique(ARG_1989_1999$study) # double checking the correct studies were subset
unique(ARG_1989_1999$year) # double checking our subsetting of years was correct
ARG_1989_1999_isolates <- length(unique(ARG_1989_1999$Isolate)) # number of isolates we have for this time point
ARG_1989_1999_isolates


# Argentina 2000-2012 data
ARG_2000_2012 <- pathotype_data_combined_s9 %>% # gathering all isolate data for the years 2000-2013 in Argentina
  subset(country=="Argentina") %>%
  subset(year>=2000 & year<= 2012)  %>%
  add_column(time_point="2000_2012", .after="study")

unique(ARG_2000_2012$study)
unique(ARG_2000_2012$year)
ARG_2000_2012_isolates <- length(unique(ARG_2000_2012$Isolate))  
ARG_2000_2012_isolates

# Argentina 2014-2019 data
ARG_2013_2019 <- pathotype_data_combined_s9 %>% # gathering all isolate data for the years 2013-2019 in Argentina
  subset(country=="Argentina") %>%
  subset(year>=2013 & year<= 2019) %>%
  add_column(time_point="2013_2019", .after="study")# Grijalba 2021 started sampling in 2013 and ended in 2015, thus it was included in this timepoint. 

unique(ARG_2013_2019$study)
unique(ARG_2013_2019$year)
ARG_2013_2019_isolates <- length(unique(ARG_2013_2019$Isolate))  
ARG_2013_2019_isolates


ARG_final_data <- rbind(ARG_1989_1999,ARG_2000_2012,ARG_2013_2019)

 #449 isolates data, without using "duprows" we would end up with 4 duplicated isolates data, all from 2013 (in both the 2000-2013 and 2014-2019 timepoints). This way allows us to use all data from isolates sampled in "2013" and those sampled in "2013-2014" or "2013-2015", which we would like to have in the 2014_2019 dataset. Setting the lower limit of the 2014-2019 timepoint to 2014 would result in the loss of ~100 isolates data, since they did not have a specific year sampled, but were instead given as a range (i.e.2013-2014 and 2013-2015). This seemed the best of both worlds so we could use all of the data as accurately as possible.


```

------------

## Canada timepoints (2000-2013, 2014-2019)
```{r}
# Canada 2000-2013 data
CAN_2000_2013 <- pathotype_data_combined_s9 %>% # gathering all isolate data for the years 2000-2013 in Canada
  subset(country=="Canada") %>%
  subset(year>=2000 & year<= 2013) %>%
  add_column(time_point="2000_2013", .after="study")

unique(CAN_2000_2013$study)
unique(CAN_2000_2013$year)
CAN_2000_2013_isolates <- length(unique(CAN_2000_2013$Isolate))  
CAN_2000_2013_isolates

# Canada 2014-2019 data
CAN_2014_2019 <- pathotype_data_combined_s9 %>% # gathering all isolate data for the years 2013-2019 in Canada
  subset(country=="Canada") %>%
  subset(year>=2014 & year<= 2019) %>%
  add_column(time_point="2014_2019", .after="study")

unique(CAN_2014_2019$study)
unique(CAN_2014_2019$year)
CAN_2014_2019_isolates <- length(unique(CAN_2014_2019$Isolate))  
CAN_2014_2019_isolates

CAN_final_data <- rbind(CAN_2000_2013,CAN_2014_2019)

```

-----------

## China timepoints (2000-2013, 2014-2019)
```{r}
CHI_1990_1999 <- pathotype_data_combined_s9 %>% # gathering all isolate data for the years 1990-1999 in China
  subset(country=="China") %>%
  subset(year>=1990 & year<= 1999) %>%
  add_column(time_point="1990_1999", .after="study") 

unique(CHI_1990_1999$study) # double checking the correct studies were subset
unique(CHI_1990_1999$year) # double checking our subsetting of years was correct
CHI_1990_1999_isolates <- length(unique(CHI_1990_1999$Isolate)) # number of isolates we have for this time point
CHI_1990_1999_isolates

CHINA_2000_2013 <- pathotype_data_combined_s9 %>% # gathering all isolate data for the years 2000-2013 in China
  subset(country=="China") %>%
  subset(year>=2000 & year<= 2013) %>%
  add_column(time_point="2000_2013", .after="study")

unique(CHINA_2000_2013$study)
unique(CHINA_2000_2013$year)
CHINA_2000_2013_isolates <- length(unique(CHINA_2000_2013$Isolate))  
CHINA_2000_2013_isolates

CHINA_2014_2019 <- pathotype_data_combined_s9 %>% # gathering all isolate data for the years 2013-2019 in Canada
  subset(country=="China") %>%
  subset(year>=2014 & year<= 2019) %>%
  add_column(time_point="2014_2019", .after="study")

unique(CHINA_2014_2019$study)
unique(CHINA_2014_2019$year)
CHINA_2014_2019_isolates <- length(unique(CHINA_2014_2019$Isolate))  
CHINA_2014_2019_isolates

CHI_final_data <- rbind(CHI_1990_1999,CHINA_2000_2013,CHINA_2014_2019)

```

We now have our dataset organized by time points (1990-1999, 2000-2013, and 2014-2019) for each of the geographic locations we will be looking at (U.S.A., Canada, Argentina and China), with only the genes (and susceptible control) tested across all studies: `r unique(pathotype_data_combined_s9$Rps)`.

------------

# Data Analysis

A reminder, the objectives of this study are:

* Identify how pathotypes have changed over time in North America, Argentina, and China
    * Significant changes in complexity, as well as effective resistance genes over time (i.e. loss of Rps1c and Rps1k for resistance in North America? Just certain areas?)
    
* Identify regional virulence trends to aid breeding efforts
    * Compare pathotype diversity between states/provinces and countries
    
## Temporal Comparison of Pathotype Complexity

###  USA

```{r}
USA_hagis_args <- list(
  x = USA_final_data,
  
  cutoff = 1, 
  
  control = "rps",
  
  sample = "Isolate",
  
  gene = "Rps",
  
  perc_susc = "Susceptible.1" 
  
)

USA_isolate_metadata <- USA_final_data[c("Isolate","study" , "year","time_point" )]

USA_complexity <- do.call(calculate_complexities, USA_hagis_args)
USA_isolate_complexity <- USA_complexity$indvidual_complexities # taking individual isolates data, not data summarized by complexity
names(USA_isolate_complexity)[names(USA_isolate_complexity)=="sample"] <- "Isolate" # renaming columns so we can merge data.frames
names(USA_isolate_complexity)[names(USA_isolate_complexity)=="N_samp"] <- "path_comp" # renaming columns so we can merge data.frames 
USA_isolate_complexity_metadata <- merge(USA_isolate_complexity, USA_isolate_metadata, by.x = c("Isolate"), by.y = c("Isolate"), all=F) # merging metadata and the complexity data
USA_isolate_complexity_metadata

USA_timepoints_mean_complexity <- USA_isolate_complexity_metadata %>%
  group_by(time_point) %>%
  mutate() %>%
  summarize(mean_comp=mean(path_comp),
            sd_comp=sd(path_comp),
            n=length(unique(Isolate)))
   # this will give us the mean and standard deviation for pathotype complexities, as well as number of isolates tested by time point. 

pander(USA_timepoints_mean_complexity) # using pander for aesthetically appealing tables in R-markdown

# Lets look at this data using a boxplot
USA_complexity_box <- ggplot(USA_isolate_complexity_metadata, aes(x=time_point, y=path_comp)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("1990_1999", "2000_2013"),c("1990_1999", "2013_2019"),c("2000_2013","2013_2019")), 
              test = "t.test",
              map_signif_level = TRUE) + 
theme(axis.text.x = element_text(size = 10, face = "bold", angle=45, hjust=1, family = "serif"),
                     axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
                     axis.title.x = element_text(size = 10, face = "bold", family = "serif"),
                     axis.title.y = element_text(size = 10, face = "bold", family = "serif"),
                     axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     legend.text = element_text(size = 10, face = "bold", family = "serif"),
                     legend.key = element_blank(),
                     legend.title = element_text(size = 10, face="bold", family = "serif"),
                     legend.position = "right",
                     strip.text.x = element_text(size = 15, face = "bold", family = "serif"),
                     title = element_text(size = 16, family = "serif")) +
                      ggtitle("USA") +
  xlab("Time Point") + ylab("Pathotype Complexity")+
  ggtitle("USA")
USA_complexity_box # looks like there was an increase in pathotype complexity at the latest timepoint, as compared to the 1990-1999 and 2000-2013 timepoints. But we dont know if they are significant or not, so lets test that next.

# testing significance between USA timepoints pathotype complexity - Welchs t.test
# Just to double check the significance tested and applied in ggpplot-ggsignif

# between 1990-1999 and 2000-2013 timepoints
USA_complexity_data_90_99_00_13 <- USA_isolate_complexity_metadata %>%
  subset(time_point!="2013_2019")
USA_sig_90_99_00_13 <- t.test(path_comp~time_point, data = USA_complexity_data_90_99_00_13)
USA_sig_90_99_00_13

# between 1990-1999 and 2014-2019 timepoints
USA_complexity_data_90_99_14_19 <- USA_isolate_complexity_metadata %>%
  subset(time_point!="2000_2013")
USA_sig_90_99_14_19 <- t.test(path_comp~time_point, data = USA_complexity_data_90_99_14_19)
USA_sig_90_99_14_19

# between 2000-2013 and 2014-2019 timepoints
USA_complexity_data_00_13_14_19 <- USA_isolate_complexity_metadata %>%
  subset(time_point!="1990_1999")
USA_sig_00_13_14_19 <- t.test(path_comp~time_point, data = USA_complexity_data_00_13_14_19)
USA_sig_00_13_14_19


```

### Argentina

```{r}
ARG_hagis_args <- list(
  x = ARG_final_data,
  
  cutoff = 1, 
  
  control = "rps",
  
  sample = "Isolate",
  
  gene = "Rps",
  
  perc_susc = "Susceptible.1" 
  
)

ARG_isolate_metadata <- ARG_final_data[c("Isolate","study" , "year","time_point" )]

ARG_complexity <- do.call(calculate_complexities, ARG_hagis_args)
ARG_isolate_complexity <- ARG_complexity$indvidual_complexities # taking individual isolates data, not data summarized by complexity
names(ARG_isolate_complexity)[names(ARG_isolate_complexity)=="sample"] <- "Isolate" # renaming columns so we can merge data.frames
names(ARG_isolate_complexity)[names(ARG_isolate_complexity)=="N_samp"] <- "path_comp" # renaming columns so we can merge data.frames 
ARG_isolate_complexity_metadata <- merge(ARG_isolate_complexity, ARG_isolate_metadata, by.x = c("Isolate"), by.y = c("Isolate"), all=F) # merging metadata and the complexity data
ARG_isolate_complexity_metadata

ARG_timepoints_mean_complexity <- ARG_isolate_complexity_metadata %>%
  group_by(time_point) %>%
  mutate() %>%
  summarize(mean_comp=mean(path_comp),
            sd_comp=sd(path_comp),
            n=length(unique(Isolate))) # this will give us the mean and standard deviation for pathotype complexities, as well as number of isolates tested by time point. 

pander(ARG_timepoints_mean_complexity) # using pander for aesthetically appealing tables in R-markdown

# Lets look at this data using a boxplot
ARG_complexity_box <- ggplot(ARG_isolate_complexity_metadata, aes(x=time_point, y=path_comp)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("1989_1999", "2000_2012"),c("1989_1999", "2013_2019"),c("2000_2012","2013_2019")), 
              test = "t.test",
              map_signif_level = TRUE) +
  theme(axis.text.x = element_text(size = 10, face = "bold", angle=45, hjust=1, family = "serif"),
                     axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
                     axis.title.x = element_text(size = 10, face = "bold", family = "serif"),
                     axis.title.y = element_text(size = 10, face = "bold", family = "serif"),
                     axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     legend.text = element_text(size = 10, face = "bold", family = "serif"),
                     legend.key = element_blank(),
                     legend.title = element_text(size = 10, face="bold", family = "serif"),
                     legend.position = "right",
                     strip.text.x = element_text(size = 15, face = "bold", family = "serif"),
                     title = element_text(size = 16, family = "serif")) +
                      ggtitle("USA") +
  xlab("Time Point") + ylab("Pathotype Complexity")+
  ggtitle("Argentina")
ARG_complexity_box # looks like there was an increase in pathotype complexity at the latest timepoint, as compared to the 1990-1999 and 2000-2013 timepoints. But we dont know if they are significant or not, so lets test that next.

# testing significance between Argentina timepoints pathotype complexity - Welchs t.test

# between 1989-1999 and 2000-2012 timepoints
ARG_complexity_data_89_99_00_12 <- ARG_isolate_complexity_metadata %>%
  subset(time_point!="2013_2019")
ARG_sig_89_99_00_12 <- t.test(path_comp~time_point, data = ARG_complexity_data_89_99_00_12)
ARG_sig_89_99_00_12

# between 1989-1999 and 2013-2019 timepoints
ARG_complexity_data_89_99_13_19 <- ARG_isolate_complexity_metadata %>%
  subset(time_point!="2000_2012")
ARG_sig_89_99_13_19 <- t.test(path_comp~time_point, data = ARG_complexity_data_89_99_13_19)
ARG_sig_89_99_13_19

# between 2000-2012 and 2013-2019 timepoints
ARG_complexity_data_00_12_13_19 <- ARG_isolate_complexity_metadata %>%
  subset(time_point!="1989_1999")
ARG_sig_00_12_13_19 <- t.test(path_comp~time_point, data = ARG_complexity_data_00_12_13_19)
ARG_sig_00_12_13_19

```

### Canada

```{r}
CAN_hagis_args <- list(
  x = CAN_final_data,
  
  cutoff = 1, 
  
  control = "rps",
  
  sample = "Isolate",
  
  gene = "Rps",
  
  perc_susc = "Susceptible.1" 
  
)

CAN_isolate_metadata <- CAN_final_data[c("Isolate","study" , "year","time_point" )]

CAN_complexity <- do.call(calculate_complexities, CAN_hagis_args)
CAN_isolate_complexity <- CAN_complexity$indvidual_complexities # taking individual isolates data, not data summarized by complexity
names(CAN_isolate_complexity)[names(CAN_isolate_complexity)=="sample"] <- "Isolate" # renaming columns so we can merge data.frames
names(CAN_isolate_complexity)[names(CAN_isolate_complexity)=="N_samp"] <- "path_comp" # renaming columns so we can merge data.frames 
CAN_isolate_complexity_metadata <- merge(CAN_isolate_complexity, CAN_isolate_metadata, by.x = c("Isolate"), by.y = c("Isolate"), all=F) # merging metadata and the complexity data
CAN_isolate_complexity_metadata

CAN_timepoints_mean_complexity <- CAN_isolate_complexity_metadata %>%
  group_by(time_point) %>%
  mutate() %>%
  summarize(mean_comp=mean(path_comp),
            sd_comp=sd(path_comp),
            n=length(unique(Isolate))) # this will give us the mean and standard deviation for pathotype complexities, as well as number of isolates tested by time point. 

pander(CAN_timepoints_mean_complexity) # using pander for aesthetically appealing tables in R-markdown

# Lets look at this data using a boxplot
CAN_complexity_box <- ggplot(CAN_isolate_complexity_metadata, aes(x=time_point, y=path_comp)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("2000_2013","2014_2019")), 
              test = "t.test",
              map_signif_level = TRUE) +
  theme(axis.text.x = element_text(size = 10, face = "bold", angle=45, hjust=1, family = "serif"),
                     axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
                     axis.title.x = element_text(size = 10, face = "bold", family = "serif"),
                     axis.title.y = element_text(size = 10, face = "bold", family = "serif"),
                     axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     legend.text = element_text(size = 10, face = "bold", family = "serif"),
                     legend.key = element_blank(),
                     legend.title = element_text(size = 10, face="bold", family = "serif"),
                     legend.position = "right",
                     strip.text.x = element_text(size = 15, face = "bold", family = "serif"),
                     title = element_text(size = 16, family = "serif")) +
                      ggtitle("USA") +
  xlab("Time Point") + ylab("Pathotype Complexity")+
  ggtitle("Canada")
CAN_complexity_box # looks like there was a slight decrease in pathotype complexity at the latest timepoint, as compared to the 2000-2013 timepoint. But we dont know if they are significant or not, so lets test that next.

# testing significance between Canada timepoints pathotype complexity - Welchs t.test

# between 1990-1999 and 2000-2013 timepoints
#CAN_complexity_data_90_99_00_13 <- CAN_isolate_complexity_metadata %>%
#  subset(time_point!="2014_2019")
#CAN_sig_90_99_00_13 <- t.test(path_comp~time_point, data = CAN_complexity_data_90_99_00_13)
#CAN_sig_90_99_00_13

# between 1990-1999 and 2014-2019 timepoints
#CAN_complexity_data_90_99_14_19 <- CAN_isolate_complexity_metadata %>%
#  subset(time_point!="2000_2013")
#CAN_sig_90_99_14_19 <- t.test(path_comp~time_point, data = CAN_complexity_data_90_99_14_19)
#CAN_sig_90_99_14_19

# between 2000-2013 and 2014-2019 timepoints
CAN_complexity_data_00_13_14_19 <- CAN_isolate_complexity_metadata %>%
  subset(time_point!="1990_1999")
CAN_sig_00_13_14_19 <- t.test(path_comp~time_point, data = CAN_complexity_data_00_13_14_19)
CAN_sig_00_13_14_19


```

### China
```{r}
CHI_hagis_args <- list(
  x = CHI_final_data,
  
  cutoff = 1, 
  
  control = "rps",
  
  sample = "Isolate",
  
  gene = "Rps",
  
  perc_susc = "Susceptible.1" 
  
)

CHI_isolate_metadata <- CHI_final_data[c("Isolate","study" , "year","time_point" )]

CHI_complexity <- do.call(calculate_complexities, CHI_hagis_args)
CHI_isolate_complexity <- CHI_complexity$indvidual_complexities # taking individual isolates data, not data summarized by complexity
names(CHI_isolate_complexity)[names(CHI_isolate_complexity)=="sample"] <- "Isolate" # renaming columns so we can merge data.frames
names(CHI_isolate_complexity)[names(CHI_isolate_complexity)=="N_samp"] <- "path_comp" # renaming columns so we can merge data.frames 
CHI_isolate_complexity_metadata <- merge(CHI_isolate_complexity, CHI_isolate_metadata, by.x = c("Isolate"), by.y = c("Isolate"), all=F) # merging metadata and the complexity data
CHI_isolate_complexity_metadata

CHI_timepoints_mean_complexity <- CHI_isolate_complexity_metadata %>%
  group_by(time_point) %>%
  mutate() %>%
  summarize(mean_comp=mean(path_comp),
            sd_comp=sd(path_comp),
            n=length(unique(Isolate))) # this will give us the mean and standard deviation for pathotype complexities, as well as number of isolates tested by time point. 

pander(CHI_timepoints_mean_complexity) # using pander for aesthetically appealing tables in R-markdown

# Lets look at this data using a boxplot
CHI_complexity_box <- ggplot(CHI_isolate_complexity_metadata, aes(x=time_point, y=path_comp)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("1990_1999", "2000_2013")), 
              test = "t.test",
              map_signif_level = TRUE) +
  theme(axis.text.x = element_text(size = 10, face = "bold", angle=45, hjust=1, family = "serif"),
                     axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
                     axis.title.x = element_text(size = 10, face = "bold", family = "serif"),
                     axis.title.y = element_text(size = 10, face = "bold", family = "serif"),
                     axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     legend.text = element_text(size = 10, face = "bold", family = "serif"),
                     legend.key = element_blank(),
                     legend.title = element_text(size = 10, face="bold", family = "serif"),
                     legend.position = "right",
                     strip.text.x = element_text(size = 15, face = "bold", family = "serif"),
                     title = element_text(size = 16, family = "serif")) +
                      ggtitle("USA") +
  xlab("Time Point") + ylab("Pathotype Complexity")+
  ggtitle("China")
CHI_complexity_box 

# testing significance between China timepoints pathotype complexity - Welchs t.test

# between 1990-1999 and 2000-2013 timepoints
CHI_complexity_data_90_99_00_13 <- CHI_isolate_complexity_metadata %>%
  subset(time_point!="2014_2019")
CHI_sig_90_99_00_13 <- t.test(path_comp~time_point, data = CHI_complexity_data_90_99_00_13)
CHI_sig_90_99_00_13

# between 1990-1999 and 2014-2019 timepoints
#CHI_complexity_data_90_99_14_19 <- CHI_isolate_complexity_metadata %>%
#  subset(time_point!="2000_2013")
#CHI_sig_90_99_14_19 <- t.test(path_comp~time_point, data = CHI_complexity_data_90_99_14_19)
#CHI_sig_90_99_14_19

# between 2000-2013 and 2014-2019 timepoints
#CHI_complexity_data_00_13_14_19 <- CHI_isolate_complexity_metadata %>%
#  subset(time_point!="1990_1999")
#CHI_sig_00_13_14_19 <- t.test(path_comp~time_point, data = CHI_complexity_data_00_13_14_19)
#CHI_sig_00_13_14_19


```
# Summary graphic of pathotype complexity over time for each country
```{r}
combined_path_comp_temporal <- plot_grid(ARG_complexity_box,CAN_complexity_box,CHI_complexity_box,USA_complexity_box)
combined_path_comp_temporal
```


--------------

# Temporal comparison of Pathotype diversity

## USA
```{r}
#USA_diversity_1990_1999 <- USA_final_data

```


--------------

# Temporal comparison of Rps gene efficacy

## USA
```{r}

USA_timepoint_gene_summary <- USA_final_data %>%
  group_by(time_point, Rps) %>%
  mutate() %>%
  summarize(N_pathogenic=sum(Susceptible.1),
            perc_pathogenic=((N_pathogenic)/(length(unique(Isolate)))*100))
# this will give us the number and percent of isolates pathogenic on each Rps gene tested, for each study we have.

plot <- ggplot(USA_timepoint_gene_summary, aes(Rps, perc_pathogenic, fill=time_point))
plot <- plot + geom_bar(stat = "identity", position = 'dodge', col = '#4d4d4d')
USA_rps_eff_tim <- plot + theme_gray() +
  theme(axis.text.x = element_text(size = 10, face = "bold", angle=45, hjust=1, family = "serif"),
                     axis.text.y = element_text(size = 10, face = "bold", family = "serif"),
                     axis.title.x = element_text(size = 15, face = "bold", family = "serif"),
                     axis.title.y = element_text(size = 10, face = "bold", family = "serif"),
                     axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     legend.text = element_text(size = 10, face = "bold", family = "serif"),
                     legend.key = element_blank(),
                     legend.title = element_text(size = 10, face="bold", family = "serif"),
                     legend.position = "right",
                     strip.text.x = element_text(size = 15, face = "bold", family = "serif"),
                     title = element_text(size = 16, family = "serif")) +
                      ggtitle("USA") +
  xlab("Rps gene") + ylab("Percent Isolates Pathogenic")
USA_rps_eff_tim

```

## Argentina
```{r}

ARG_timepoint_gene_summary <- ARG_final_data %>%
  group_by(time_point, Rps) %>%
  mutate() %>%
  summarize(N_pathogenic=sum(Susceptible.1),
            perc_pathogenic=((N_pathogenic)/(length(unique(Isolate)))*100))
# this will give us the number and percent of isolates pathogenic on each Rps gene tested, for each study we have.

plot <- ggplot(ARG_timepoint_gene_summary, aes(Rps, perc_pathogenic, fill=time_point))
plot <- plot + geom_bar(stat = "identity", position = 'dodge', col = '#4d4d4d')
ARG_rps_eff_tim <- plot + theme_gray() +
  theme(axis.text.x = element_text(size = 10, face = "bold", angle=45, hjust=1, family = "serif"),
                     axis.text.y = element_text(size = 10, face = "bold", family = "serif"),
                     axis.title.x = element_text(size = 15, face = "bold", family = "serif"),
                     axis.title.y = element_text(size = 10, face = "bold", family = "serif"),
                     axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     legend.text = element_text(size = 10, face = "bold", family = "serif"),
                     legend.key = element_blank(),
                     legend.title = element_text(size = 10, face="bold", family = "serif"),
                     legend.position = "right",
                     strip.text.x = element_text(size = 15, face = "bold", family = "serif"),
                     title = element_text(size = 16, family = "serif")) +
                      ggtitle("Argentina") +
  xlab("Rps gene") + ylab("Percent Isolates Pathogenic")
ARG_rps_eff_tim

```

## Canada 
#### (double check that this is correct, I expected a higher percent pathogenic for Rps1k, even though Rps1a and Rps1c is "lost")
```{r}

CAN_timepoint_gene_summary <- CAN_final_data %>%
  group_by(time_point, Rps) %>%
  mutate() %>%
  summarize(N_pathogenic=sum(Susceptible.1),
            perc_pathogenic=((N_pathogenic)/(length(unique(Isolate)))*100))
# this will give us the number and percent of isolates pathogenic on each Rps gene tested, for each study we have.

plot <- ggplot(CAN_timepoint_gene_summary, aes(Rps, perc_pathogenic, fill=time_point))
plot <- plot + geom_bar(stat = "identity", position = 'dodge', col = '#4d4d4d')
CAN_rps_eff_tim <- plot + theme_gray() +
  theme(axis.text.x = element_text(size = 10, face = "bold", angle=45, hjust=1, family = "serif"),
                     axis.text.y = element_text(size = 10, face = "bold", family = "serif"),
                     axis.title.x = element_text(size = 15, face = "bold", family = "serif"),
                     axis.title.y = element_text(size = 10, face = "bold", family = "serif"),
                     axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     legend.text = element_text(size = 10, face = "bold", family = "serif"),
                     legend.key = element_blank(),
                     legend.title = element_text(size = 10, face="bold", family = "serif"),
                     legend.position = "right",
                     strip.text.x = element_text(size = 15, face = "bold", family = "serif"),
                     title = element_text(size = 16, family = "serif")) +
                      ggtitle("Canada") +
  xlab("Rps gene") + ylab("Percent Isolates Pathogenic")
CAN_rps_eff_tim

```

## China
```{r}
CHI_timepoint_gene_summary <- CHI_final_data %>%
  group_by(time_point, Rps) %>%
  mutate() %>%
  summarize(N_pathogenic=sum(Susceptible.1),
            perc_pathogenic=((N_pathogenic)/(length(unique(Isolate)))*100))
# this will give us the number and percent of isolates pathogenic on each Rps gene tested, for each study we have.

plot <- ggplot(CHI_timepoint_gene_summary, aes(Rps, perc_pathogenic, fill=time_point))
plot <- plot + geom_bar(stat = "identity", position = 'dodge', col = '#4d4d4d')
CHI_rps_eff_tim <- plot + theme_gray() +
  theme(axis.text.x = element_text(size = 10, face = "bold", angle=45, hjust=1, family = "serif"),
                     axis.text.y = element_text(size = 10, face = "bold", family = "serif"),
                     axis.title.x = element_text(size = 15, face = "bold", family = "serif"),
                     axis.title.y = element_text(size = 10, face = "bold", family = "serif"),
                     axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     legend.text = element_text(size = 10, face = "bold", family = "serif"),
                     legend.key = element_blank(),
                     legend.title = element_text(size = 10, face="bold", family = "serif"),
                     legend.position = "right",
                     strip.text.x = element_text(size = 15, face = "bold", family = "serif"),
                     title = element_text(size = 16, family = "serif")) +
                      ggtitle("China") +
  xlab("Rps gene") + ylab("Percent Isolates Pathogenic")
CHI_rps_eff_tim

```
# Combined summary figure on resistance-gene efficacy
```{r}
# bar-graphs on resistance-gene efficacy
combined_gene_eff_temporal <- plot_grid(ARG_rps_eff_tim,CAN_rps_eff_tim,CHI_rps_eff_tim,USA_rps_eff_tim)
combined_gene_eff_temporal
```

So, it looks like there may have been significant and distinct changes in gene efficacy between our determined time points for each region except China, which did not have large changes in resistance-gene efficacy. However, We do not know if these changes in virulence over time are significant, and relevant to breeders or for changes management approach (i.e. use a different gene). Likewise, this just shows us a summary of which genes may have changed in efficacy, not how the sampled populations pathotype structure of each region has changed over time.

To determine if/how the sampled populations pathotype structure has changed over time, we will use Principal Coordinate analysis (PCoA) to first visualize each regions pathotype structure by timepoint to see if they are distinct. We will then use a Permutational Multivariate Analysis of Variance (PERMANOVA) to determine if the populations pathotype structure is significantly different at each timepoint. Lastly, we will use a Discriminant Analysis of Principal Components (DAPC) to determine which genes specifically are driving the differences in each timepoints sampled populations pathotype structure. 

From these comparison analyses we will be able to identify 1.) __If__ the sampled _P. sojae_ populations pathotype structure have changed significantly over time, and 2.) __which genes__ the sampled populations have adapted to thus driving the differences we (may) see between timepoints.

So, without further ado &#127932; Lets get down to business... &#127932;

# Temporal comparison of the sampled populations pathotype structure

To do these analyses we will need to take our regional data sets and turn them each into a data matrix. We can do this using the _hagis_ R package function `create_binary_matrix()`. This will allow for downstream analyses using packages like `vegan` and `ape`.


## USA virulence matrix
```{r}
# we are going to remove the isolates now that have a gene-subsetted complexity of 0
#to do this we will combine the USA_isolate_complexity file and the USA_final_data file, then filter, keeping only the isolates that do not have a pathotype complexity of 0

USA_final_data_comp <- merge(USA_final_data, USA_isolate_complexity, by.x = c("Isolate"), by.y = c("Isolate"), all=F)

USA_final_data_comp_no0 <- USA_final_data_comp %>%
                    subset(path_comp!="0") %>% # remove those isolates with 0 pathotype complexity
                    subset(Rps!="rps") # remove the susceptible control, seeing if this will fix my error as all isolates would have virulence on this differential
# creating the binary virulence matrix to be used for PCoA

USA_vir_matrix <- create_binary_matrix(x = USA_final_data_comp_no0,
  
  cutoff = 1, 
  
  control = "rps",
  
  sample = "Isolate",
  
  gene = "Rps",
  
  perc_susc = "Susceptible.1") # this creates a binary matrix of virulence, but has no metadata associated




```

## USA calculating Jaccard distances 
```{r}
# Jaccard distances on USA_vir_matrix 
USA_vir_jaccard <- vegdist(USA_vir_matrix, "jaccard", na.rm = TRUE)
#any(is.complex(USA_vir_jaccard))
```

## USA Principal Coordinates Analysis 
```{r}
#USA_vir_pcoa <- cmdscale(USA_vir_jaccard, eig = TRUE) # this is the PCoA, using the stats package instead of ape as ape was throwing errors with our large dataset.
#test <- pcoscaled(USA_vir_jaccard)
USA_pca <- pcoa(USA_vir_jaccard)
#plot( )
# calculate the percentage of variation that each Principle Coordinate accounts for
USA_Axis1.percent <- USA_pca$values$Relative_eig[[1]]*100 # Dimension (Axis 1 (PcoA1)) 42.10312%
USA_Axis2.percent <- USA_pca$values$Relative_eig[[2]]*100 # Dimension (Axis 2 (PcoA2)) 21.40556%
USA_Axis3.percent <- USA_pca$values$Relative_eig[[3]]*100 # 
USA_Axis4.percent <- USA_pca$values$Relative_eig[[4]]*100
USA_Axis5.percent <- USA_pca$values$Relative_eig[[5]]*100
USA_Axis6.percent <- USA_pca$values$Relative_eig[[6]]*100
USA_Axis7.percent <- USA_pca$values$Relative_eig[[7]]*100
USA_Axis8.percent <- USA_pca$values$Relative_eig[[8]]*100


barplot(USA_pca$values$Relative_eig[1:10]) # looks like the first two principal components account for nearly 65% of the variance, so we will just use those

USA_pca_data <- data.frame(sample = rownames(USA_pca$vectors),
                                      X = USA_pca$vectors[, 1],
                                      Y = USA_pca$vectors[, 2])


```

## adding metadata to PCoA 
```{r}
names(USA_pca_data)[names(USA_pca_data)=="sample"] <- "Isolate" # renaming columns so we can merge data.frames
USA_pca_metadata <- left_join(USA_pca_data, USA_isolate_metadata, by = "Isolate")
head(USA_pca_metadata)
```

## Plotting USA PCoA data
```{r}
str(USA_pca_metadata)

print(unique(USA_pca_metadata$time_point))

USA_pcoa_plot <- ggplot(data = USA_pca_metadata, aes(x = X, y = Y)) +
  geom_point(aes(colour = time_point)) +
  xlab(paste("PcoA1 - ", round(USA_Axis1.percent,2), "%", sep = "")) +
  ylab(paste("PcoA2 - ", round(USA_Axis2.percent,2), "%", sep = "")) +
  theme_bw() +
  theme(
    axis.title.x = element_text(face = "bold", size = 15),
    axis.title.y = element_text(face = "bold", size = 15),
    axis.text = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(face = "bold", size = 10),
    legend.key.size = unit(1, 'lines')
  ) +
  stat_ellipse(aes(x = X, y = Y, color=time_point, group=time_point), level = 0.95) +
  ggtitle("USA")

USA_pcoa_plot

```

--------------

## Argentina virulence matrix
```{r}
# we are going to remove the isolates now that have a gene-subsetted complexity of 0

ARG_final_data_comp <- merge(ARG_final_data, ARG_isolate_complexity, by.x = c("Isolate"), by.y = c("Isolate"), all=F)

ARG_final_data_comp_no0 <- ARG_final_data_comp %>%
                    subset(path_comp!="0") %>% # remove those isolates with 0 pathotype complexity
                    subset(Rps!="rps") # remove the susceptible control

str(ARG_final_data_comp_no0)

# creating the binary virulence matrix to be used for PCoA

ARG_vir_matrix <- create_binary_matrix(x = ARG_final_data_comp_no0,
  
  cutoff = 1, 
  
  control = "rps",
  
  sample = "Isolate",
  
  gene = "Rps",
  
  perc_susc = "Susceptible.1") # this creates a binary matrix of virulence, but has no metadata associated.

```

## Argentina calculating Jaccard distances 
```{r}
# Jaccard distances on USA_vir_matrix 
ARG_vir_jaccard <- vegdist(ARG_vir_matrix, "jaccard", na.rm = TRUE)
#any(is.complex(USA_vir_jaccard))
```

## Argentina Principal Coordinates Analysis 
```{r}
ARG_pca <- pcoa(ARG_vir_jaccard)

# calculate the percentage of variation that each Principle Coordinate accounts for
ARG_Axis1.percent <- ARG_pca$values$Relative_eig[[1]]*100 # Dimension (Axis 1 (PcoA1)) 49.56%
ARG_Axis2.percent <- ARG_pca$values$Relative_eig[[2]]*100 # Dimension (Axis 2 (PcoA2)) 18.89%
ARG_Axis3.percent <- ARG_pca$values$Relative_eig[[3]]*100 # 
ARG_Axis4.percent <- ARG_pca$values$Relative_eig[[4]]*100
ARG_Axis5.percent <- ARG_pca$values$Relative_eig[[5]]*100
ARG_Axis6.percent <- ARG_pca$values$Relative_eig[[6]]*100
ARG_Axis7.percent <- ARG_pca$values$Relative_eig[[7]]*100
ARG_Axis8.percent <- ARG_pca$values$Relative_eig[[8]]*100


barplot(ARG_pca$values$Relative_eig[1:10]) # 

ARG_pca_data <- data.frame(sample = rownames(ARG_pca$vectors),
                                      X = ARG_pca$vectors[, 1],
                                      Y = ARG_pca$vectors[, 2])


```

## adding metadata to PCoA 
```{r}
names(ARG_pca_data)[names(ARG_pca_data)=="sample"] <- "Isolate" # renaming columns so we can merge data.frames
ARG_pca_metadata <- left_join(ARG_pca_data, ARG_isolate_metadata, by = "Isolate")
head(ARG_pca_metadata)
```

## Plotting Argentina PCoA data
```{r}
str(ARG_pca_metadata)

print(unique(ARG_pca_metadata$time_point))

ARG_pcoa_plot <- ggplot(data = ARG_pca_metadata, aes(x = X, y = Y)) +
  geom_point(aes(colour = time_point)) +
  xlab(paste("PcoA1 - ", round(ARG_Axis1.percent,2), "%", sep = "")) +
  ylab(paste("PcoA2 - ", round(ARG_Axis2.percent,2), "%", sep = "")) +
  theme_bw() +
  theme(
    axis.title.x = element_text(face = "bold", size = 15),
    axis.title.y = element_text(face = "bold", size = 15),
    axis.text = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(face = "bold", size = 10),
    legend.key.size = unit(1, 'lines')
  ) +
  stat_ellipse(aes(x = X, y = Y, color=time_point, group=time_point), level = 0.95) +
  ggtitle("Argentina")

ARG_pcoa_plot

```

-------------

## Canada virulence matrix
```{r}
# we are going to remove the isolates now that have a gene-subsetted complexity of 0

CAN_final_data_comp <- merge(CAN_final_data, CAN_isolate_complexity, by.x = c("Isolate"), by.y = c("Isolate"), all=F)

CAN_final_data_comp_no0 <- CAN_final_data_comp %>%
                    subset(path_comp!="0") %>% # remove those isolates with 0 pathotype complexity
                    subset(Rps!="rps") # remove the susceptible control

str(CAN_final_data_comp_no0)

# creating the binary virulence matrix to be used for PCoA

CAN_vir_matrix <- create_binary_matrix(x = CAN_final_data_comp_no0,
  
  cutoff = 1, 
  
  control = "rps",
  
  sample = "Isolate",
  
  gene = "Rps",
  
  perc_susc = "Susceptible.1") # this creates a binary matrix of virulence, but has no metadata associated.

```

## Canada calculating Jaccard distances 
```{r}
# Jaccard distances on USA_vir_matrix 
CAN_vir_jaccard <- vegdist(CAN_vir_matrix, "jaccard", na.rm = TRUE)
#any(is.complex(USA_vir_jaccard))
```

## Canada Principal Coordinates Analysis 
```{r}
CAN_pca <- pcoa(CAN_vir_jaccard)

# calculate the percentage of variation that each Principle Coordinate accounts for
CAN_Axis1.percent <- CAN_pca$values$Relative_eig[[1]]*100 # Dimension (Axis 1 (PcoA1)) 46.90%
CAN_Axis2.percent <- CAN_pca$values$Relative_eig[[2]]*100 # Dimension (Axis 2 (PcoA2)) 31.14%
CAN_Axis3.percent <- CAN_pca$values$Relative_eig[[3]]*100 # 
CAN_Axis4.percent <- CAN_pca$values$Relative_eig[[4]]*100
CAN_Axis5.percent <- CAN_pca$values$Relative_eig[[5]]*100
CAN_Axis6.percent <- CAN_pca$values$Relative_eig[[6]]*100
CAN_Axis7.percent <- CAN_pca$values$Relative_eig[[7]]*100
CAN_Axis8.percent <- CAN_pca$values$Relative_eig[[8]]*100


barplot(CAN_pca$values$Relative_eig[1:10]) # 

CAN_pca_data <- data.frame(sample = rownames(CAN_pca$vectors),
                                      X = CAN_pca$vectors[, 1],
                                      Y = CAN_pca$vectors[, 2])


```

## adding metadata to PCoA 
```{r}
names(CAN_pca_data)[names(CAN_pca_data)=="sample"] <- "Isolate" # renaming columns so we can merge data.frames
CAN_pca_metadata <- left_join(CAN_pca_data, CAN_isolate_metadata, by = "Isolate")
head(CAN_pca_metadata)
```

## Plotting Canada PCoA data
```{r}
CAN_pcoa_plot <- ggplot(data = CAN_pca_metadata, aes(x = X, y = Y)) +
  geom_point(aes(colour = time_point)) +
  xlab(paste("PcoA1 - ", round(CAN_Axis1.percent,2), "%", sep = "")) +
  ylab(paste("PcoA2 - ", round(CAN_Axis2.percent,2), "%", sep = "")) +
  theme_bw() +
  theme(
    axis.title.x = element_text(face = "bold", size = 15),
    axis.title.y = element_text(face = "bold", size = 15),
    axis.text = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(face = "bold", size = 10),
    legend.key.size = unit(1, 'lines')
  ) +
  stat_ellipse(aes(x = X, y = Y, color=time_point, group=time_point), level = 0.95) +
  ggtitle("Canada")

CAN_pcoa_plot

```

-------------

## China virulence matrix
```{r}
# we are going to remove the isolates now that have a gene-subsetted complexity of 0

CHI_final_data_comp <- merge(CHI_final_data, CHI_isolate_complexity, by.x = c("Isolate"), by.y = c("Isolate"), all=F)

CHI_final_data_comp_no0 <- CHI_final_data_comp %>%
                    subset(path_comp!="0") %>% # remove those isolates with 0 pathotype complexity
                    subset(Rps!="rps") # remove the susceptible control

str(CHI_final_data_comp_no0)

# creating the binary virulence matrix to be used for PCoA

CHI_vir_matrix <- create_binary_matrix(x = CHI_final_data_comp_no0,
  
  cutoff = 1, 
  
  control = "rps",
  
  sample = "Isolate",
  
  gene = "Rps",
  
  perc_susc = "Susceptible.1") # this creates a binary matrix of virulence, but has no metadata associated.

```

## China calculating Jaccard distances 
```{r}
# Jaccard distances on USA_vir_matrix 
CHI_vir_jaccard <- vegdist(CHI_vir_matrix, "jaccard", na.rm = TRUE)
#any(is.complex(USA_vir_jaccard))
```

## China Principal Coordinates Analysis 
```{r}
CHI_pca <- pcoa(CHI_vir_jaccard)

# calculate the percentage of variation that each Principle Coordinate accounts for
CHI_Axis1.percent <- CHI_pca$values$Relative_eig[[1]]*100 # Dimension (Axis 1 (PcoA1)) 30.26%
CHI_Axis2.percent <- CHI_pca$values$Relative_eig[[2]]*100 # Dimension (Axis 2 (PcoA2)) 18.78%
CHI_Axis3.percent <- CHI_pca$values$Relative_eig[[3]]*100 # 
CHI_Axis4.percent <- CHI_pca$values$Relative_eig[[4]]*100
CHI_Axis5.percent <- CHI_pca$values$Relative_eig[[5]]*100
CHI_Axis6.percent <- CHI_pca$values$Relative_eig[[6]]*100
CHI_Axis7.percent <- CHI_pca$values$Relative_eig[[7]]*100
CHI_Axis8.percent <- CHI_pca$values$Relative_eig[[8]]*100


barplot(CHI_pca$values$Relative_eig[1:10]) # 

CHI_pca_data <- data.frame(sample = rownames(CHI_pca$vectors),
                                      X = CHI_pca$vectors[, 1],
                                      Y = CHI_pca$vectors[, 2])


```

## adding metadata to PCoA 
```{r}
names(CHI_pca_data)[names(CHI_pca_data)=="sample"] <- "Isolate" # renaming columns so we can merge data.frames
CHI_pca_metadata <- left_join(CHI_pca_data, CHI_isolate_metadata, by = "Isolate")
head(CHI_pca_metadata)
```

## Plotting China PCoA data
```{r}
CHI_pcoa_plot <- ggplot(data = CHI_pca_metadata, aes(x = X, y = Y)) +
  geom_point(aes(colour = time_point)) +
  xlab(paste("PcoA1 - ", round(CHI_Axis1.percent,2), "%", sep = "")) +
  ylab(paste("PcoA2 - ", round(CHI_Axis2.percent,2), "%", sep = "")) +
  theme_bw() +
  theme(
    axis.title.x = element_text(face = "bold", size = 15),
    axis.title.y = element_text(face = "bold", size = 15),
    axis.text = element_text(face = "bold", size = 10),
    legend.title = element_text(face = "bold", size = 10),
    legend.text = element_text(face = "bold", size = 10),
    legend.key.size = unit(1, 'lines')
  ) +
  stat_ellipse(aes(x = X, y = Y, color=time_point, group=time_point), level = 0.95) +
  ggtitle("China")

CHI_pcoa_plot

```


-------------

## PCOA plots side by side
```{r}
combined_PCOA_temporal <- plot_grid(ARG_pcoa_plot,CAN_pcoa_plot,CHI_pcoa_plot,USA_pcoa_plot)
combined_PCOA_temporal

```






